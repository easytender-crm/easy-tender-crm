<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Easy Tender CRM - Final (Firebase)</title>
  <style>
    :root{--primary:#0057ff;--bg:#f4f6f9;--card:#fff}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#0b1b2b}
    .center{display:flex;align-items:center;justify-content:center;height:100vh}
    .card{background:var(--card);padding:18px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.08);width:100%;max-width:900px}
    input,select,button,textarea{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #ddd;box-sizing:border-box}
    .row{display:flex;gap:10px}
    .row .col{flex:1}
    .btn{background:var(--primary);color:#fff;border:none;padding:10px;border-radius:6px;cursor:pointer}
    header{padding:12px 18px;background:linear-gradient(90deg,var(--primary),#00c6ff);color:#fff}
    nav{display:flex;gap:8px;align-items:center}
    .sidebar{width:220px;padding:12px;background:linear-gradient(180deg,var(--primary),#00c6ff);color:#fff;height:calc(100vh - 64px)}
    .layout{display:flex;min-height:calc(100vh - 64px)}
    .main{flex:1;padding:18px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .tag{padding:4px 8px;border-radius:6px;color:#fff;font-weight:600}
    .today{background:#28a745}.future{background:#17a2b8}.registered{background:#ffc107;color:#000}.noti{background:#dc3545}
    .hidden{display:none}
    footer{padding:12px;text-align:center;font-size:13px;color:#666}
    a.small{font-size:13px;color:var(--primary);text-decoration:none}
  </style>
</head>
<body>
  <header>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;gap:12px;align-items:center">
        <img src="LOGO.jpg" alt="Logo" style="height:44px;border-radius:6px;background:#fff;padding:6px"/>
        <div>
          <div style="font-weight:700">Easy Tender CRM</div>
          <div style="font-size:12px;opacity:0.9">Cloud CRM (Firebase)</div>
        </div>
      </div>
      <div id="userArea"></div>
    </div>
  </header>

  <!-- LOGIN / REGISTER -->
  <div id="loginScreen" class="center">
    <div class="card">
      <h2 style="margin:0 0 8px 0">Easy Tender CRM — Login</h2>
      <p style="margin:0 0 12px 0">Use your email and password. Admin: <strong>easytender2025@gmail.com</strong></p>
      <input id="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <div style="display:flex;gap:8px">
        <button class="btn" id="loginBtn">Login</button>
        <button id="signupBtn" style="background:#eee;color:#000;border:1px solid #ccc">Sign Up</button>
      </div>
      <p style="margin-top:10px;font-size:13px;color:#444">Default Admin if first login: <strong>easytender2025@gmail.com / Prem@2003</strong></p>
      <p style="margin-top:6px"><a class="small" href="#" id="forgot">Forgot password?</a></p>
    </div>
  </div>

  <!-- APP -->
  <div id="appArea" class="hidden">
    <div class="layout">
      <aside class="sidebar">
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:14px">
          <img src="LOGO.jpg" style="height:48px;width:48px;object-fit:contain;background:#fff;padding:6px;border-radius:8px"/>
          <div>
            <div style="font-weight:700">Easy Tender</div>
            <div style="font-size:12px;opacity:0.9">Empowering Your Business</div>
          </div>
        </div>

        <nav>
          <button class="btn" id="navDashboard" style="width:100%;background:transparent;border:1px solid rgba(255,255,255,0.08);color:#fff;padding:10px;text-align:left">Dashboard</button>
        </nav>

        <div style="margin-top:12px">
          <button id="navToday" style="width:100%;margin-bottom:6px">Today Follow-up</button>
          <button id="navFuture" style="width:100%;margin-bottom:6px">Future Follow-up</button>
          <button id="navRegistered" style="width:100%;margin-bottom:6px">Registered</button>
          <button id="navNoti" style="width:100%">Not Interested</button>
        </div>

        <div style="margin-top:auto;font-size:13px;opacity:0.9">
          Support: support@easytender.com<br/>+91-98765-43210
        </div>
      </aside>

      <main class="main">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div>
            <input id="search" placeholder="Search by name or mobile..." style="width:300px"/>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="logoutBtn" class="btn" style="background:#ff5252">Logout</button>
          </div>
        </div>

        <div id="dashboardView">
          <div class="card" style="margin-bottom:12px">
            <h3>Add Client</h3>
            <div class="row">
              <div class="col"><input id="clientName" placeholder="Client Name"/></div>
              <div class="col"><input id="companyName" placeholder="Company Name"/></div>
            </div>
            <div class="row">
              <div class="col"><input id="mobile" placeholder="Mobile Number"/></div>
              <div class="col"><input id="city" placeholder="City"/></div>
            </div>
            <div class="row">
              <div class="col"><input id="state" placeholder="State"/></div>
              <div class="col"><input id="followDate" type="date"/></div>
            </div>
            <textarea id="remarks" placeholder="Remarks"></textarea>
            <div style="display:flex;gap:8px">
              <select id="status"><option value="today">Today Follow-up</option><option value="future">Future Follow-up</option><option value="registered">Registered</option><option value="noti">Not Interested</option></select>
              <button id="saveClient" class="btn">Save Client</button>
            </div>
          </div>

          <div class="card">
            <h3>Client List</h3>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:8px">
              <button id="exportBtn" class="btn">Export CSV</button>
              <input type="file" id="csvFile"/>
            </div>
            <table>
              <thead><tr><th>Name</th><th>Company</th><th>Mobile</th><th>City</th><th>State</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="clientsTable"></tbody>
            </table>
          </div>
        </div>

        <div id="adminView" class="hidden card" style="margin-top:12px">
          <h3>Admin — Staff Management</h3>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="staffEmail" placeholder="Staff email"/>
            <input id="staffPass" placeholder="Password"/>
            <button id="createStaff" class="btn">Create Staff</button>
          </div>
          <h4>Staff List</h4>
          <table><thead><tr><th>Email</th><th>Role</th><th>UID</th></tr></thead><tbody id="staffTable"></tbody></table>
        </div>

        <footer style="margin-top:18px">
          <small>Easy Tender CRM • Version 1.0</small>
        </footer>
      </main>
    </div>
  </div>

  <!-- Firebase SDKs (modular) -->
  <script type="module">
    // Firebase imports (CDN modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, onSnapshot, orderBy, doc, updateDoc, deleteDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // FIREBASE CONFIG (you provided)
    const firebaseConfig = {
      apiKey: "AIzaSyD9HvxCQD9LoUMpdH6Ne6Ujna5wKFx75aM",
      authDomain: "easy-tender-crm.firebaseapp.com",
      projectId: "easy-tender-crm",
      storageBucket: "easy-tender-crm.firebasestorage.app",
      messagingSenderId: "405693483846",
      appId: "1:405693483846:web:5e38afb1fdf40da7baf347"
    };

    const adminEmail = "easytender2025@gmail.com";
    const adminDefaultPassword = "Prem@2003";

    // init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI elements
    const loginScreen = document.getElementById('loginScreen');
    const appArea = document.getElementById('appArea');
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const forgot = document.getElementById('forgot');
    const userArea = document.getElementById('userArea');
    const logoutBtn = document.getElementById('logoutBtn');

    // App elements
    const saveClientBtn = document.getElementById('saveClient');
    const clientsTable = document.getElementById('clientsTable');
    const exportBtn = document.getElementById('exportBtn');
    const csvFile = document.getElementById('csvFile');
    const search = document.getElementById('search');

    // Admin elements
    const adminView = document.getElementById('adminView');
    const staffEmail = document.getElementById('staffEmail');
    const staffPass = document.getElementById('staffPass');
    const createStaffBtn = document.getElementById('createStaff');
    const staffTable = document.getElementById('staffTable');

    let currentUser = null;
    let currentRole = 'staff'; // auto-assigned
    let clientsUnsub = null;

    // Helper: show/hide
    function showLogin(){ loginScreen.classList.remove('hidden'); appArea.classList.add('hidden'); userArea.innerHTML=''; }
    function showApp(){ loginScreen.classList.add('hidden'); appArea.classList.remove('hidden'); }

    // AUTH: login
    loginBtn.addEventListener('click', async ()=>{
      const e = emailEl.value.trim(); const p = passEl.value.trim();
      if(!e || !p){ alert('Enter email and password'); return; }
      try{
        await signInWithEmailAndPassword(auth, e, p);
      }catch(err){ alert('Login error: '+err.message); }
    });

    // signup: create user (simple)
    signupBtn.addEventListener('click', async ()=>{
      const e = emailEl.value.trim(); const p = passEl.value.trim();
      if(!e || !p){ alert('Enter email and password'); return; }
      try{
        const userCred = await createUserWithEmailAndPassword(auth, e, p);
        // create user doc in firestore
        await setDoc(doc(db,'users',userCred.user.uid), { email:e, role: (e===adminEmail? 'admin':'staff'), uid:userCred.user.uid });
        alert('User created. Please login.');
      }catch(err){ alert('Signup error: '+err.message); }
    });

    forgot.addEventListener('click', async (e)=>{
      e.preventDefault();
      const eaddr = prompt('Enter your email to reset password:');
      if(!eaddr) return;
      try{ await sendPasswordResetEmail(auth,eaddr); alert('Password reset email sent.'); }catch(err){ alert(err.message); }
    });

    // on auth state changed
    onAuthStateChanged(auth, async user => {
      if(user){
        currentUser = user;
        // Auto-admin logic: if this email is adminEmail => role admin
        if(user.email === adminEmail){
          currentRole = 'admin';
        } else {
          // check firestore users collection for role
          const udoc = await getDoc(doc(db,'users',user.uid));
          if(udoc.exists()){
            currentRole = udoc.data().role || 'staff';
          } else {
            currentRole = 'staff';
            await setDoc(doc(db,'users',user.uid), { email:user.email, role:'staff', uid:user.uid });
          }
        }
        userArea.innerHTML = `<div style="text-align:right"><div>${user.email}</div><div style="font-size:12px;color:#fff;opacity:0.9">Role: ${currentRole}</div></div>`;
        showApp();
        // show admin panel if admin
        adminView.classList.toggle('hidden', currentRole !== 'admin');
        if(currentRole==='admin') loadStaff();
        // load clients stream
        subscribeClients();
      } else {
        currentUser = null;
        currentRole = 'staff';
        if(clientsUnsub) clientsUnsub();
        showLogin();
      }
    });

    logoutBtn.addEventListener('click', ()=>{ signOut(auth); });

    // Firestore: subscribe clients (admin: all, staff: createdBy == uid)
    function subscribeClients(){
      if(clientsUnsub) clientsUnsub();
      let q;
      const col = collection(db,'clients');
      if(currentRole==='admin'){
        q = query(col, orderBy('createdAt','desc'));
        // realtime
        clientsUnsub = onSnapshot(q, snap => { renderClients(snap.docs.map(d=>({id:d.id, ...d.data()}))); });
      } else {
        q = query(col, where('createdBy','==', currentUser.uid), orderBy('createdAt','desc'));
        clientsUnsub = onSnapshot(q, snap => { renderClients(snap.docs.map(d=>({id:d.id, ...d.data()}))); });
      }
    }

    // Save client
    saveClientBtn.addEventListener('click', async ()=>{
      const data = {
        name: document.getElementById('clientName').value.trim(),
        company: document.getElementById('companyName').value.trim(),
        mobile: document.getElementById('mobile').value.trim(),
        city: document.getElementById('city').value.trim(),
        state: document.getElementById('state').value.trim(),
        date: document.getElementById('followDate').value || '',
        remarks: document.getElementById('remarks').value.trim(),
        status: document.getElementById('status').value,
        createdBy: currentUser.uid,
        createdAt: new Date()
      };
      if(!data.name || !data.mobile){ alert('Name and mobile required'); return; }
      try{
        await addDoc(collection(db,'clients'), data);
        // clear
        document.getElementById('clientName').value=''; document.getElementById('companyName').value=''; document.getElementById('mobile').value=''; document.getElementById('city').value=''; document.getElementById('state').value=''; document.getElementById('followDate').value=''; document.getElementById('remarks').value='';
        alert('Client saved.');
      }catch(err){ alert('Save error: '+err.message); }
    });

    // render clients into table
    function renderClients(items){
      clientsTable.innerHTML = items.map((c, i)=>`
        <tr>
          <td>${escapeHtml(c.name)}</td>
          <td>${escapeHtml(c.company||'')}</td>
          <td>${escapeHtml(c.mobile)}</td>
          <td>${escapeHtml(c.city||'')}</td>
          <td>${escapeHtml(c.state||'')}</td>
          <td>${c.date||''}</td>
          <td><span class="tag ${c.status}">${c.status}</span></td>
          <td>
            <button onclick="editClient('${c.id}')" style="margin-right:6px">Edit</button>
            <button onclick="deleteClient('${c.id}')" style="margin-right:6px">Delete</button>
            <button onclick="moveStatus('${c.id}','today')">Today</button>
            <button onclick="moveStatus('${c.id}','future')">Future</button>
            <button onclick="moveStatus('${c.id}','registered')">Reg</button>
            <button onclick="moveStatus('${c.id}','noti')">Noti</button>
          </td>
        </tr>
      `).join('');
    }

    // global helpers exposed for onclick
    window.editClient = async function(id){
      const d = await getDoc(doc(db,'clients',id));
      if(!d.exists()) return alert('No record');
      const data = d.data();
      document.getElementById('clientName').value = data.name || '';
      document.getElementById('companyName').value = data.company || '';
      document.getElementById('mobile').value = data.mobile || '';
      document.getElementById('city').value = data.city || '';
      document.getElementById('state').value = data.state || '';
      document.getElementById('followDate').value = data.date || '';
      document.getElementById('remarks').value = data.remarks || '';
      document.getElementById('status').value = data.status || 'today';
      // store editing id on button
      saveClientBtn.dataset.editing = id;
      saveClientBtn.innerText = 'Update Client';
      saveClientBtn.onclick = async ()=>{
        const idd = saveClientBtn.dataset.editing;
        const ref = doc(db,'clients',idd);
        await updateDoc(ref, {
          name: document.getElementById('clientName').value.trim(),
          company: document.getElementById('companyName').value.trim(),
          mobile: document.getElementById('mobile').value.trim(),
          city: document.getElementById('city').value.trim(),
          state: document.getElementById('state').value.trim(),
          date: document.getElementById('followDate').value || '',
          remarks: document.getElementById('remarks').value.trim(),
          status: document.getElementById('status').value
        });
        alert('Updated');
        saveClientBtn.innerText = 'Save Client';
        saveClientBtn.onclick = null;
        saveClientBtn.removeAttribute('data-editing');
        saveClientBtn.onclick = async ()=>{ /* rebind original after update */ addClientTrigger(); };
        addClientTrigger(); // rebind
      };
    };

    // delete
    window.deleteClient = async function(id){
      if(!confirm('Delete this client?')) return;
      await deleteDoc(doc(db,'clients',id));
      alert('Deleted');
    };

    window.moveStatus = async function(id,status){
      await updateDoc(doc(db,'clients',id), { status: status });
    };

    function addClientTrigger(){
      saveClientBtn.onclick = async ()=>{
        const data = {
          name: document.getElementById('clientName').value.trim(),
          company: document.getElementById('companyName').value.trim(),
          mobile: document.getElementById('mobile').value.trim(),
          city: document.getElementById('city').value.trim(),
          state: document.getElementById('state').value.trim(),
          date: document.getElementById('followDate').value || '',
          remarks: document.getElementById('remarks').value.trim(),
          status: document.getElementById('status').value,
          createdBy: currentUser.uid,
          createdAt: new Date()
        };
        if(!data.name || !data.mobile){ alert('Name and mobile required'); return; }
        await addDoc(collection(db,'clients'), data);
        // clear
        document.getElementById('clientName').value=''; document.getElementById('companyName').value=''; document.getElementById('mobile').value=''; document.getElementById('city').value=''; document.getElementById('state').value=''; document.getElementById('followDate').value=''; document.getElementById('remarks').value='';
      };
    }
    addClientTrigger();

    // search
    search.addEventListener('input', ()=>{
      const q = search.value.trim().toLowerCase();
      if(!q){ subscribeClients(); return; }
      // simple client-side filter after fetching all for admin
      (async ()=>{
        const snap = await getDocs(collection(db,'clients'));
        const items = snap.docs.map(d=>({id:d.id,...d.data()})).filter(c=> (c.name||'').toLowerCase().includes(q) || (c.mobile||'').includes(q));
        renderClients(items);
      })();
    });

    // export CSV
    exportBtn.addEventListener('click', async ()=>{
      const snap = await getDocs(collection(db,'clients'));
      const rows = snap.docs.map(d=>d.data());
      const csv = ['Name,Company,Mobile,City,State,Date,Status,Remarks'].concat(rows.map(r=>`"${(r.name||'')}","${(r.company||'')}","${(r.mobile||'')}","${(r.city||'')}","${(r.state||'')}","${(r.date||'')}","${(r.status||'')}","${(r.remarks||'')}"`)).join('\n');
      const a = document.createElement('a'); a.href = 'data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='EasyTender_Clients.csv'; a.click();
    });

    // CSV import basic
    csvFile.addEventListener('change', (ev)=>{
      const f = ev.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = async (e)=>{
        const lines = e.target.result.split('\n').map(l=>l.trim()).filter(Boolean);
        if(lines.length<2) return alert('CSV must have header and rows');
        // skip header
        lines.slice(1).forEach(async row=>{
          const cols = row.split(',');
          if(cols.length<7) return;
          try{
            await addDoc(collection(db,'clients'), {
              name: cols[0].replace(/"/g,''),
              company: cols[1].replace(/"/g,''),
              mobile: cols[2].replace(/"/g,''),
              city: cols[3].replace(/"/g,''),
              state: cols[4].replace(/"/g,''),
              date: cols[5].replace(/"/g,''),
              status: cols[6].replace(/"/g,''),
              remarks: cols[7]?cols[7].replace(/"/g,''):'',
              createdBy: currentUser.uid,
              createdAt: new Date()
            });
          }catch(e){ console.error(e); }
        });
        alert('Import done (may take a few seconds).');
      };
      reader.readAsText(f);
    });

    // ADMIN: create staff (creates auth user via signup and user doc)
    createStaffBtn.addEventListener('click', async ()=>{
      const e = staffEmail.value.trim(); const p = staffPass.value.trim();
      if(!e || !p) return alert('Provide email & password');
      try{
        // create auth user via admin? We cannot from client. Instead we create an invite record; staff should signup
        await addDoc(collection(db,'invites'), { email:e, role:'staff', createdAt: new Date(), createdBy: currentUser.uid });
        alert('Invite created. Ask staff to sign up using that email and password (or use sign-up button).');
        staffEmail.value=''; staffPass.value='';
        loadStaff();
      }catch(err){ alert('Error: '+err.message); }
    });

    // load staff list (users collection)
    async function loadStaff(){
      staffTable.innerHTML = '';
      const snap = await getDocs(collection(db,'users'));
      snap.docs.forEach(d=>{
        const u = d.data();
        staffTable.innerHTML += `<tr><td>${u.email||''}</td><td>${u.role||'staff'}</td><td>${u.uid||''}</td></tr>`;
      });
    }

    // escape html
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" }[c])); }

    // initial view
    showLogin();

  </script>
</body>
</html>
