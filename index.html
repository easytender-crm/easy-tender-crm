<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Easy Tender CRM â€” Final Working</title>
<style>
:root{--primary:#0066ff;--accent:#00b4d8;--bg:#f4f6f9;--card:#fff}
*{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#082032}
header{height:64px;background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;display:flex;align-items:center;padding:0 18px;justify-content:space-between}
.header-left{display:flex;align-items:center;gap:12px}
.logo{height:44px;border-radius:8px;background:#fff;padding:6px}
.app-title{font-weight:700}
.layout{display:flex;min-height:calc(100vh - 64px)}
.sidebar{width:240px;padding:14px;background:#05386b;color:#fff;display:flex;flex-direction:column}
.menu-btn{background:transparent;border:none;color:inherit;text-align:left;padding:10px;border-radius:6px;margin-bottom:6px;cursor:pointer;font-weight:600}
.menu-btn.active{background:rgba(255,255,255,0.06)}
.main{flex:1;padding:18px}
.controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
.card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(12,24,36,0.06);margin-bottom:12px}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
.kpi{padding:18px;border-radius:8px;background:linear-gradient(180deg,#fff,#f7fbff);text-align:center;cursor:pointer}
.kpi .num{font-size:20px;font-weight:700;color:var(--primary)}
.form-row{display:flex;gap:8px;margin-bottom:8px}
.form-row .col{flex:1}
input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd}
table{width:100%;border-collapse:collapse;background:var(--card);border-radius:8px;overflow:hidden}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
th{background:#f6fbff;color:var(--primary);font-weight:700}
.tag{padding:6px 8px;border-radius:6px;color:#fff;font-weight:700;display:inline-block;font-size:13px}
.today{background:#28a745}.future{background:#17a2b8}.registered{background:#ffc107;color:#000}.noti{background:#dc3545}.fresh{background:#6f42c1}
.actions button{margin-right:6px;padding:6px 8px;border-radius:6px;border:none;cursor:pointer}
.actions .edit{background:#00b4d8;color:#fff}.actions .del{background:#ff5252;color:#fff}.actions .quick{background:#0066ff;color:#fff}
.small{font-size:13px;color:#666}
.right{margin-left:auto}
.footer{padding:12px;text-align:center;color:#666;font-size:13px}
.modal{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:999}
.modal .box{width:920px;max-width:96%;background:#fff;padding:12px;border-radius:8px;max-height:90vh;overflow:auto}
.timeline{display:flex;flex-direction:column;gap:12px}
.timeline-item{background:#fff;border-radius:8px;padding:10px;box-shadow:0 2px 8px rgba(0,0,0,0.04)}
.timeline-meta{color:#666;font-size:13px;margin-top:6px}
.hidden{display:none !important;}
@media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}.sidebar{width:72px}.menu-btn{font-size:11px;padding:8px}}
@media(max-width:640px){.grid{grid-template-columns:1fr}.sidebar{display:none}.main{padding:12px}}
</style>
</head>
<body>
<header>
  <div class="header-left">
    <img src="LOGO.jpg" class="logo" alt="Logo"/>
    <div>
      <div class="app-title">Easy Tender CRM</div>
      <div class="small">Telecalling â€” Final</div>
    </div>
  </div>
  <div id="hdrRight" class="small"></div>
</header>

<div class="layout">
  <aside class="sidebar">
    <button class="menu-btn active" data-page="dashboard" onclick="openPage('dashboard', this)">Dashboard</button>
    <button class="menu-btn" data-page="all" onclick="openPage('all', this)">Total Clients</button>
    <button class="menu-btn" data-page="today" onclick="openPage('today', this)">Today Follow-up</button>
    <button class="menu-btn" data-page="future" onclick="openPage('future', this)">Future Follow-up</button>
    <button class="menu-btn" data-page="registered" onclick="openPage('registered', this)">Registered</button>
    <button class="menu-btn" data-page="noti" onclick="openPage('noti', this)">Not Interested</button>
    <button class="menu-btn" data-page="fresh" onclick="openPage('fresh', this)">Fresh Data</button>
    <div style="margin-top:12px">
      <button class="menu-btn" data-page="add" onclick="openPage('add', this)">Add Client</button>
      <button class="menu-btn" data-page="import" onclick="openPage('import', this)">Import / Export</button>
      <button class="menu-btn" data-page="staff" onclick="openPage('staff', this)">Staff (Admin)</button>
    </div>
    <div style="margin-top:auto;font-size:13px;opacity:0.9">Support: support@easytender.com<br/>+91-98765-43210</div>
  </aside>

  <main class="main">
    <div class="controls">
      <input id="search" placeholder="Search name or mobile..." style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd"/>
      <select id="filterStaff" style="width:220px"><option value="">All Staff</option></select>
      <button id="logoutBtn" class="btn">Logout</button>
    </div>

    <!-- Dashboard -->
    <div id="page_dashboard" class="page">
      <div class="grid card" id="kpis">
        <div class="kpi" onclick="openKpi('all')"><div class="num" id="k_total">0</div><div class="small">Total Clients</div></div>
        <div class="kpi" onclick="openKpi('today')"><div class="num" id="k_today">0</div><div class="small">Today Follow-ups</div></div>
        <div class="kpi" onclick="openKpi('future')"><div class="num" id="k_future">0</div><div class="small">Future Follow-ups</div></div>
        <div class="kpi" onclick="openKpi('registered')"><div class="num" id="k_registered">0</div><div class="small">Registered</div></div>
      </div>

      <div class="card" id="addQuickCard">
        <h3 style="margin-top:0">Add New Client (Quick)</h3>
        <div class="form-row">
          <input id="n_company" placeholder="Company Name" />
          <input id="n_name" placeholder="Client Name" />
        </div>
        <div class="form-row">
          <input id="n_mobile" placeholder="Mobile Number" />
          <input id="n_city" placeholder="City" />
        </div>
        <div class="form-row">
          <input id="n_state" placeholder="State" />
          <select id="n_status" style="width:160px">
            <option value="fresh">Fresh</option>
            <option value="today">Today</option>
            <option value="future">Future</option>
            <option value="registered">Registered</option>
            <option value="noti">Not Interested</option>
          </select>
          <button class="btn" onclick="addFreshClient()" style="white-space:nowrap">Add Client</button>
        </div>
      </div>

      <div class="card">
        <h3>Recent Activity</h3>
        <div id="recentList" class="timeline"></div>
      </div>
    </div>

    <!-- All / Filtered list -->
    <div id="page_list" class="page hidden">
      <div class="card">
        <div style="display:flex;align-items:center;gap:8px">
          <h3 id="listTitle">Clients</h3>
          <div class="right small" id="listCount"></div>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table id="clientsTable">
            <thead><tr><th>Name</th><th>Company</th><th>Mobile</th><th>City</th><th>State</th><th>Follow-up</th><th>Status</th><th>Assigned</th><th>Actions</th></tr></thead>
            <tbody id="clientsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Fresh page -->
    <div id="page_fresh" class="page hidden">
      <div class="card">
        <h3>Fresh Data (No Remarks)</h3>
        <div style="overflow:auto;margin-top:8px">
          <table id="freshTable">
            <thead><tr><th>Name</th><th>Company</th><th>Mobile</th><th>City</th><th>State</th><th>Added</th><th>Actions</th></tr></thead>
            <tbody id="freshBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Add full -->
    <div id="page_add" class="page hidden">
      <div class="card">
        <h3 id="addTitle">Add Client (Full)</h3>
        <div class="form-row">
          <div class="col"><input id="name" placeholder="Client Name"/></div>
          <div class="col"><input id="company" placeholder="Company"/></div>
        </div>
        <div class="form-row">
          <div class="col"><input id="mobile" placeholder="Mobile"/></div>
          <div class="col"><input id="city" placeholder="City"/></div>
        </div>
        <div class="form-row">
          <div class="col"><input id="state" placeholder="State"/></div>
          <div class="col"><input id="follow" type="date"/></div>
        </div>
        <div style="margin-bottom:8px">
          <textarea id="note" placeholder="Initial remark / note" style="width:100%;min-height:80px"></textarea>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="statusSelect"><option value="fresh">Fresh</option><option value="today">Today</option><option value="future">Future</option><option value="registered">Registered</option><option value="noti">Not Interested</option></select>
          <select id="assignSelect" style="min-width:180px"><option value="">Assign to staff (optional)</option></select>
          <button id="saveBtn" class="btn">Save Client</button>
          <button id="clearBtn" class="btn" style="background:#777">Clear</button>
        </div>
      </div>
    </div>

    <!-- Import -->
    <div id="page_import" class="page hidden">
      <div class="card">
        <h3>Import / Export</h3>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <input type="file" id="csvIn"/>
          <button id="importBtn" class="btn">Import CSV</button>
          <button id="exportAll" class="btn">Export All CSV</button>
          <button id="exportToday" class="btn">Export Today</button>
        </div>
        <div class="small">CSV format: Name,Company,Mobile,City,State,FollowDate,Status,Remark</div>
      </div>
    </div>

    <!-- Staff -->
    <div id="page_staff" class="page hidden">
      <div class="card">
        <h3>Staff Management (Admin)</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="staffEmail" placeholder="staff email"/>
          <input id="staffPass" placeholder="password"/>
          <button id="createStaff" class="btn">Create Staff (Invite)</button>
        </div>
        <div class="card"><h4>Staff List</h4><div id="staffList"></div></div>
      </div>
    </div>

    <div class="footer card">Easy Tender CRM â€¢ Telecalling Final</div>

  </main>
</div>

<!-- Modal -->
<div id="modal" class="modal hidden"><div class="box">
  <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
    <h3 id="modalName">Client</h3>
    <div><button class="btn" onclick="closeModal()">Close</button></div>
  </div>
  <div id="modalBody"></div>
</div></div>

<!-- JS -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, getDoc, query, where, orderBy, onSnapshot, updateDoc, deleteDoc, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// config
const firebaseConfig = {
  apiKey: "AIzaSyD9HvxCQD9LoUMpdH6Ne6Ujna5wKFx75aM",
  authDomain: "easy-tender-crm.firebaseapp.com",
  projectId: "easy-tender-crm",
  storageBucket: "easy-tender-crm.firebasestorage.app",
  messagingSenderId: "405693483846",
  appId: "1:405693483846:web:5e38afb1fdf40da7baf347"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const adminEmail = "easytender2025@gmail.com";

// refs
const hdrRight = document.getElementById('hdrRight');
const search = document.getElementById('search');
const filterStaff = document.getElementById('filterStaff');
const logoutBtn = document.getElementById('logoutBtn');
const recentList = document.getElementById('recentList');
const clientsBody = document.getElementById('clientsBody');
const listCount = document.getElementById('listCount');
const listTitle = document.getElementById('listTitle');
const freshBody = document.getElementById('freshBody');

const n_company = document.getElementById('n_company');
const n_name = document.getElementById('n_name');
const n_mobile = document.getElementById('n_mobile');
const n_city = document.getElementById('n_city');
const n_state = document.getElementById('n_state');
const n_status = document.getElementById('n_status');

const saveBtn = document.getElementById('saveBtn');
const clearBtn = document.getElementById('clearBtn');
const nameEl = document.getElementById('name');
const companyEl = document.getElementById('company');
const mobileEl = document.getElementById('mobile');
const cityEl = document.getElementById('city');
const stateEl = document.getElementById('state');
const followEl = document.getElementById('follow');
const noteEl = document.getElementById('note');
const statusSelect = document.getElementById('statusSelect');
const assignSelect = document.getElementById('assignSelect');
const csvIn = document.getElementById('csvIn');
const importBtn = document.getElementById('importBtn');
const exportAll = document.getElementById('exportAll');
const exportToday = document.getElementById('exportToday');
const staffList = document.getElementById('staffList');
const createStaff = document.getElementById('createStaff');
const staffEmail = document.getElementById('staffEmail');
const staffPass = document.getElementById('staffPass');

const modal = document.getElementById('modal');
const modalName = document.getElementById('modalName');
const modalBody = document.getElementById('modalBody');

const pages = ['dashboard','all','today','future','registered','noti','fresh','add','import','staff'];
let currentUser = null;
let currentRole = 'staff';
let currentPage = 'dashboard';
let unsub = null;

// helpers
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function createStatusTag(s){ return `<span class="tag ${s}">${s}</span>`; }
function closeModal(){ modal.classList.add('hidden'); modalBody.innerHTML=''; }
window.closeModal = closeModal;

// auth UI
hdrRight.innerHTML = '<button class="btn" onclick="doLoginPrompt()">Login / Signup</button>';
logoutBtn.addEventListener('click', ()=> signOut(auth).then(()=>{ window.location.reload(); }).catch(()=>window.location.reload()));

// login prompt
async function doLoginPrompt(){ const em = prompt('Email'); if(!em) return; const pw = prompt('Password'); if(!pw) return; try{ await signInWithEmailAndPassword(auth,em,pw); }catch(e){ if(e.code && e.code.includes('user-not-found')){ if(confirm('User not found. Create account?')){ try{ await createUserWithEmailAndPassword(auth,em,pw); alert('Created. Please login.'); }catch(err){ alert(err.message); } } } else alert(e.message); } }
window.doLoginPrompt = doLoginPrompt;

// auth state
onAuthStateChanged(auth, async user=>{
  if(user){
    currentUser = user;
    currentRole = (user.email===adminEmail)?'admin':'staff';
    hdrRight.innerHTML = `
      <div style="margin-bottom:15px; padding:10px; border:1px solid #ddd; border-radius:6px;">
        <h4>Quick Update</h4>
        <div>
          <strong>Change Status:</strong>
          <select id="quickStatusSelect" style="width:200px; padding:6px;">
            <option value="today">Today</option>
            <option value="future">Future</option>
            <option value="registered">Registered</option>
            <option value="noti">Not Interested</option>
            <option value="fresh">Fresh</option>
          </select>
        </div>
        <div style="margin-top:10px;">
          <strong>Remark:</strong>
          <textarea id="quickRemark" style="width:100%; height:70px;"></textarea>
        </div>
        <button class="btn" style="margin-top:10px;" onclick="quickUpdate('${id}')">Save Update</button>
      </div>
    <div style="text-align:right"><div style="font-weight:700">${user.email}</div><div class="small">${currentRole}</div></div>`;
    await fillAssigns();
    loadKpis();
    if(currentPage && currentPage!=='add' && currentPage!=='import' && currentPage!=='staff') loadList(currentPage);
  } else {
    currentUser = null;
    currentRole = 'staff';
    hdrRight.innerHTML = '<button class="btn" onclick="doLoginPrompt()">Login / Signup</button>';
    // show dashboard but require login for actions
    openPage('dashboard');
  }
});

// fill assigns
async function fillAssigns(){
  try{
    filterStaff.innerHTML = '<option value="">All Staff</option>';
    assignSelect.innerHTML = '<option value="">Assign to staff (optional)</option>';
    staffList.innerHTML = '';
    const snap = await getDocs(collection(db,'users'));
    snap.docs.forEach(d=>{
      const u = d.data();
      const opt = document.createElement('option'); opt.value = u.uid; opt.textContent = u.email; filterStaff.appendChild(opt);
      const opt2 = document.createElement('option'); opt2.value = u.uid; opt2.textContent = u.email; assignSelect.appendChild(opt2);
      const div = document.createElement('div'); div.textContent = `${u.email} â€” ${u.role||'staff'}`; staffList.appendChild(div);
    });
  }catch(e){ console.error('fillAssigns',e); }
}

// open page
window.openPage = function(page, btn){
  document.querySelectorAll('.menu-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  currentPage = page;
  document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
  if(page==='dashboard'){ document.getElementById('page_dashboard').classList.remove('hidden'); loadKpis(); loadRecent(); }
  else if(page==='fresh'){ document.getElementById('page_fresh').classList.remove('hidden'); loadFresh(); }
  else if(page==='add'){ document.getElementById('page_add').classList.remove('hidden'); fillAssigns(); }
  else if(page==='import'){ document.getElementById('page_import').classList.remove('hidden'); }
  else if(page==='staff'){ document.getElementById('page_staff').classList.remove('hidden'); fillAssigns(); }
  else { document.getElementById('page_list').classList.remove('hidden'); loadList(page); }
};

// openKpi
window.openKpi = function(type){
  if(type==='all') openPage('all');
  else openPage(type);
};

// loadKpis
async function loadKpis(){
  try{
    const col = collection(db,'clients');
    const snap = await getDocs(query(col, orderBy('createdAt','desc'), limit(2000)));
    const items = snap.docs.map(d=>d.data());
    document.getElementById('k_total').innerText = items.length;
    document.getElementById('k_today').innerText = items.filter(i=>i.status==='today').length;
    document.getElementById('k_future').innerText = items.filter(i=>i.status==='future').length;
    document.getElementById('k_registered').innerText = items.filter(i=>i.status==='registered').length;
  }catch(e){ console.error(e); }
}

// loadRecent - STYLE A (timeline)
async function loadRecent(){
  try{
    const snap = await getDocs(query(collection(db,'clients'), orderBy('createdAt','desc'), limit(7)));
    const items = snap.docs.map(d=>({id:d.id,...d.data()})).filter(Boolean);
    const html = items.map(it=>{
      const status = it.status || (it.history && it.history.length? it.history[it.history.length-1].status : 'fresh');
      const dateTxt = (it.createdAt && it.createdAt.toDate) ? it.createdAt.toDate().toLocaleString() : '';
      const icon = status==='registered'?'ðŸŸ¢':status==='future'?'ðŸ”µ':status==='today'?'ðŸŸ¡':status==='noti'?'ðŸ”´':'âšª';
      return `<div class="timeline-item"><div><strong>${escapeHtml(it.name||it.company||'â€”')}</strong> ${createStatusTag(status)}</div><div class="timeline-meta">${icon} ${escapeHtml(status.toUpperCase())} â€¢ ${escapeHtml(dateTxt)}</div></div>`;
    }).join('');
    recentList.innerHTML = html || '<div class="small">No recent activity</div>';
  }catch(e){ console.error(e); recentList.innerHTML = '<div class="small">Error loading recent</div>'; }
}

// renderRow
function renderRow(docItem){
  const id = docItem.id;
  const assignedEmail = docItem.assignedToEmail || '';
  return `
    <tr>
      <td><strong>${escapeHtml(docItem.name||'')}</strong><div class="small">${escapeHtml(docItem.company||'')}</div></td>
      <td>${escapeHtml(docItem.company||'')}</td>
      <td><a class="link" href="tel:${escapeHtml(docItem.mobile||'')}">${escapeHtml(docItem.mobile||'')}</a></td>
      <td>${escapeHtml(docItem.city||'')}</td>
      <td>${escapeHtml(docItem.state||'')}</td>
      <td>${docItem.date||''}</td>
      <td>${createStatusTag(docItem.status||'fresh')}</td>
      <td>${escapeHtml(assignedEmail)}</td>
      <td class="actions">
        <button class="action edit" onclick="openDetail('${id}')">View</button>
        <button class="action quick" onclick="quickStatus('${id}','today')">Today</button>
        <button class="action quick" onclick="quickStatus('${id}','future')">Future</button>
        <button class="action quick" onclick="quickStatus('${id}','registered')">Reg</button>
        <button class="action del" onclick="removeClient('${id}')">Delete</button>
      </td>
    </tr>
  `;
}

// loadList with correct filtering
async function loadList(page){
  if(unsub) unsub();
  clientsBody.innerHTML = '<tr><td colspan="9">Loading...</td></tr>';
  try{
    const col = collection(db,'clients');
    let q;
    if(page==='all' || page==='dashboard'){
      q = query(col, orderBy('createdAt','desc'));
      listTitle.innerText = 'All Clients';
    } else if(['today','future','registered','noti','all'].includes(page)){
      q = query(col, where('status','==', page), orderBy('createdAt','desc'));
      listTitle.innerText = page==='today'?'Today Follow-up':page==='future'?'Future Follow-up':page==='registered'?'Registered':'Not Interested';
    } else {
      q = query(col, orderBy('createdAt','desc'));
      listTitle.innerText = 'Clients';
    }

    unsub = onSnapshot(q, (snap)=>{
      let docs = snap.docs.map(d=>({id:d.id,...d.data()}));
      // If user asked 'all' but many docs have no status set, include them
      if(page==='all'){
        // include documents without status as fresh
        docs = docs.map(x=>{ if(!x.status) x.status='fresh'; return x; });
      }
      const f = filterStaff.value;
      const filtered = f ? docs.filter(x=>x.assignedTo===f) : docs;
      clientsBody.innerHTML = filtered.map(renderRow).join('') || '<tr><td colspan="9">No records</td></tr>';
      listCount.innerText = filtered.length ? `${filtered.length} results` : '';
      loadKpis(); loadRecent();
    }, (err)=>{ console.error(err); clientsBody.innerHTML = '<tr><td colspan="9">Error loading</td></tr>'; });
  }catch(e){ console.error('loadList',e); clientsBody.innerHTML = '<tr><td colspan="9">Error</td></tr>'; }
}

// loadFresh
async function loadFresh(){
  freshBody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
  try{
    const col = collection(db,'clients');
    // fetch recent and filter client-side to avoid index issues
    const snap = await getDocs(query(col, orderBy('createdAt','desc'), limit(1000)));
    const rows = snap.docs.map(d=>({id:d.id,...d.data()}));
    const fresh = rows.filter(r => {
      if(r.status==='fresh') return true;
      if(!r.history || r.history.length===0) return true;
      return false;
    });
    freshBody.innerHTML = fresh.map(r=>`<tr>
      <td>${escapeHtml(r.name||'')}</td>
      <td>${escapeHtml(r.company||'')}</td>
      <td><a class="link" href="tel:${escapeHtml(r.mobile||'')}">${escapeHtml(r.mobile||'')}</a></td>
      <td>${escapeHtml(r.city||'')}</td>
      <td>${escapeHtml(r.state||'')}</td>
      <td>${(r.createdAt && r.createdAt.toDate)?r.createdAt.toDate().toLocaleString():''}</td>
      <td><button class="btn" onclick="openDetail('${r.id}')">Open</button></td>
    </tr>`).join('') || '<tr><td colspan="7">No fresh records</td></tr>';
  }catch(e){ console.error(e); freshBody.innerHTML = '<tr><td colspan="7">Error</td></tr>'; }
}

// openDetail
async function openDetail(id){
  if(!id) return;
  try{
    const d = await getDoc(doc(db,'clients',id));
    if(!d.exists()) return alert('Not found');
    const obj = d.data();
    modalName.innerText = obj.name || 'Client';
    let historyHtml = '<h4>Call History</h4>';
    if(obj.history && obj.history.length){
      historyHtml += '<div>';
      obj.history.slice().reverse().forEach(h=>{
        const ts = h.ts && h.ts.seconds ? new Date(h.ts.seconds*1000).toLocaleString() : '';
        historyHtml += `<div class="small">${ts} â€” <strong>${escapeHtml(h.user)}</strong>: ${escapeHtml(h.note)} [${escapeHtml(h.status)}]</div>`;
      });
      historyHtml += '</div>';
    } else historyHtml += '<div class="small">No history yet</div>';

    modalBody.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
        <div><strong>Mobile:</strong> ${escapeHtml(obj.mobile||'')}</div>
        <div><strong>Company:</strong> ${escapeHtml(obj.company||'')}</div>
        <div style="margin-left:auto"><strong>Status:</strong> ${createStatusTag(obj.status||'fresh')}</div>
      </div>
      <div style="display:flex;gap:12px;margin-bottom:8px">
        <button class="btn" onclick="recordOutcome('${id}','interested')">Interested</button>
        <button class="btn" onclick="recordOutcome('${id}','not-interested')">Not Interested</button>
        <button class="btn" onclick="recordOutcome('${id}','call-later')">Call Later</button>
        <button class="btn" onclick="recordOutcome('${id}','wrong-number')">Wrong Number</button>
      </div>
      <div style="margin-bottom:8px"><strong>Assign to staff:</strong> <select id="assignStaffModal"></select> <button class="btn" onclick="assignStaff('${id}')">Assign</button></div>
      <div style="margin-bottom:8px"><strong>Notes / Add Remark</strong><br/><textarea id="addNote" style="width:100%;min-height:80px"></textarea><br/><button class="btn" onclick="addRemark('${id}')">Save Remark</button></div>
      ${historyHtml}
    `;
    const snap = await getDocs(collection(db,'users'));
    const sel = document.getElementById('assignStaffModal');
    sel.innerHTML = '<option value="">(none)</option>';
    snap.docs.forEach(u=>{ const data = u.data(); const opt = document.createElement('option'); opt.value = data.uid; opt.text = data.email; sel.appendChild(opt); });
    modal.classList.remove('hidden');
  }catch(e){ console.error(e); alert('Error opening detail'); }
}

// addRemark

async function addRemark(id){
  try{
    const noteEl = document.getElementById('addNote');
    const note = noteEl ? noteEl.value.trim() : '';
    if(!note) return alert('Enter remark');

    const userEmail = currentUser ? currentUser.email : 'unknown';
    const ref = doc(db,'clients',id);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      alert('Record not found');
      return;
    }
    const data = snap.data();
    const prevHist = Array.isArray(data.history) ? data.history.slice() : [];

    prevHist.push({
      ts: serverTimestamp(),
      user: userEmail,
      note: note,
      status: data.status || 'fresh'
    });

    await updateDoc(ref, { history: prevHist });

    alert('Remark saved');
    if(noteEl) noteEl.value = '';
    openDetail(id);
    try{ loadFresh(); if(unsub) loadList(currentPage); }catch(e){console.warn(e);}
  }catch(err){
    console.error('addRemark error', err);
    alert('Error saving remark');
  }
}

// assignStaff

async function assignStaff(id){
  try{
    const sel = document.getElementById('assignStaffModal');
    if(!sel) return alert('Assign select not found');
    const uid = sel.value;
    const email = sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].text : '';
    await updateDoc(doc(db,'clients',id), { assignedTo: uid, assignedToEmail: email });
    alert('Assigned');
    openDetail(id);
    try{ if(unsub) loadList(currentPage); }catch(e){console.warn(e);}
  }catch(err){
    console.error('assignStaff error', err);
    alert('Error assigning staff');
  }
}

// recordOutcome

async function recordOutcome(id, outcome){
  try{
    const statusMap = {
      "interested": "registered",
      "not-interested": "noti",
      "call-later": "future",
      "wrong-number": "noti"
    };
    const status = statusMap[outcome] || "fresh";
    const userEmail = currentUser ? currentUser.email : "unknown";

    const ref = doc(db, "clients", id);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      alert("Record not found");
      return;
    }
    const data = snap.data();
    const history = Array.isArray(data.history) ? data.history.slice() : [];

    history.push({
      ts: serverTimestamp(),
      user: userEmail,
      note: `Outcome: ${outcome}`,
      status: status
    });

    await updateDoc(ref, {
      status: status,
      history: history
    });

    alert("Saved successfully");
    // reload modal to show updated history/status
    openDetail(id);
    // update lists and KPIs in background (non-blocking)
    try{ loadKpis(); loadRecent(); loadFresh(); if(unsub) loadList(currentPage); }catch(e){console.warn(e);}
  }catch(err){
    console.error("recordOutcome error:", err);
    alert("Error saving outcome");
  }
}

// quickStatus
async function quickStatus(id, st){
  await updateDoc(doc(db,'clients',id), { status: st });
  alert('Status updated');
  if(unsub) loadList(currentPage);
}

// removeClient
async function removeClient(id){
  if(!confirm('Delete this client?')) return;
  await deleteDoc(doc(db,'clients',id));
  alert('Deleted');
  if(unsub) loadList(currentPage);
  loadFresh(); loadKpis(); loadRecent();
}

// full save
saveBtn && saveBtn.addEventListener && saveBtn.addEventListener('click', async ()=>{
  const payload = {
    name: nameEl.value.trim(),
    company: companyEl.value.trim(),
    mobile: mobileEl.value.trim(),
    city: cityEl.value.trim(),
    state: stateEl.value.trim(),
    date: followEl.value || '',
    status: statusSelect.value || 'fresh',
    assignedTo: assignSelect.value || '',
    assignedToEmail: assignSelect.options[assignSelect.selectedIndex] ? assignSelect.options[assignSelect.selectedIndex].text : '',
    createdAt: serverTimestamp()
  };
  if(!payload.name || !payload.mobile) return alert('Name and mobile required');
  const res = await addDoc(collection(db,'clients'), payload);
  if(noteEl.value.trim()){
    await updateDoc(doc(db,'clients',res.id), { history: [{ ts: serverTimestamp(), user: currentUser ? currentUser.email : 'system', note: noteEl.value.trim(), status: payload.status }] });
  }
  alert('Saved');
  nameEl.value=''; companyEl.value=''; mobileEl.value=''; cityEl.value=''; stateEl.value=''; followEl.value=''; noteEl.value=''; statusSelect.value='fresh'; assignSelect.value='';
  loadList(currentPage);
  loadFresh(); loadKpis(); loadRecent();
});

// addFreshClient
window.addFreshClient = async function(){
  if(!currentUser){
    if(!confirm('You are not logged in. Add client as guest?')) return;
  }
  const company = (n_company && n_company.value)||'';
  const name = (n_name && n_name.value)||'';
  const mobile = (n_mobile && n_mobile.value)||'';
  const city = (n_city && n_city.value)||'';
  const state = (n_state && n_state.value)||'';
  const status = (n_status && n_status.value) || 'fresh';
  if(!company || !name || !mobile){ alert('Company, Name & Mobile required'); return; }
  await addDoc(collection(db,'clients'), { company,name,mobile,city,state,status,history:[],createdAt:serverTimestamp(),createdBy:currentUser?currentUser.uid:'' });
  if(n_company) n_company.value=''; if(n_name) n_name.value=''; if(n_mobile) n_mobile.value=''; if(n_city) n_city.value=''; if(n_state) n_state.value='';
  alert('Client added');
  loadFresh(); loadKpis(); loadRecent();
  if(currentPage==='all' || currentPage==='fresh') loadList(currentPage);
};

// import/export
importBtn && importBtn.addEventListener && importBtn.addEventListener('click', ()=>{
  const f = csvIn.files[0]; if(!f) return alert('Choose file');
  const reader = new FileReader();
  reader.onload = async (e)=>{
    const lines = e.target.result.split('\n').map(s=>s.trim()).filter(Boolean); if(lines.length<2) return alert('CSV needs header+rows');
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(',').map(c=>c.replace(/^"|"$/g,''));
      await addDoc(collection(db,'clients'), { name: cols[0]||'', company: cols[1]||'', mobile: cols[2]||'', city: cols[3]||'', state: cols[4]||'', date: cols[5]||'', status: cols[6]||'fresh', history: cols[7]?[{ ts: serverTimestamp(), user: 'import', note: cols[7], status: cols[6]||'fresh' }]:[], createdAt: serverTimestamp() });
    }
    alert('Imported');
    loadFresh(); if(unsub) loadList(currentPage);
  };
  reader.readAsText(f);
});

// export helpers
function downloadCsv(filename, rows){
  const csv = rows.map(r=>`"${(r.name||'')}","${(r.company||'')}","${(r.mobile||'')}","${(r.city||'')}","${(r.state||'')}","${(r.date||'')}","${(r.status||'')}","${(r.history && r.history.length? r.history.map(h=>h.note).join(';') : '')}"`).join('\n');
  const a = document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent('Name,Company,Mobile,City,State,FollowDate,Status,Remarks\n'+csv); a.download=filename; a.click();
}
exportAll && exportAll.addEventListener && exportAll.addEventListener('click', async ()=>{ const snap = await getDocs(collection(db,'clients')); const rows = snap.docs.map(d=>d.data()); downloadCsv('all_clients.csv', rows); });
exportToday && exportToday.addEventListener && exportToday.addEventListener('click', async ()=>{ const snap = await getDocs(query(collection(db,'clients'), where('status','==','today'))); const rows= snap.docs.map(d=>d.data()); downloadCsv('today_clients.csv', rows); });

// create staff
createStaff && createStaff.addEventListener && createStaff.addEventListener('click', async ()=>{
  const e = staffEmail.value.trim(), p = staffPass.value.trim();
  if(!e||!p) return alert('Enter email & password');
  await addDoc(collection(db,'invites'), { email:e, role:'staff', createdAt: serverTimestamp(), createdBy: currentUser?currentUser.uid:'' });
  await addDoc(collection(db,'users'), { email:e, role:'staff', uid:'pending-'+Date.now() });
  alert('Invite recorded.');
  staffEmail.value=''; staffPass.value='';
  fillAssigns();
});

// search
search.addEventListener('input', ()=>{ const q = search.value.trim().toLowerCase(); if(!q) return loadList(currentPage); (async ()=>{ const snap = await getDocs(collection(db,'clients')); const items = snap.docs.map(d=>({id:d.id,...d.data()})).filter(c=> (c.name||'').toLowerCase().includes(q) || (c.mobile||'').includes(q)); clientsBody.innerHTML = items.map(renderRow).join('') || '<tr><td colspan="9">No records</td></tr>'; })(); });


async function quickUpdate(id){
  try{
    const newStatus=document.getElementById("quickStatusSelect").value;
    const note=document.getElementById("quickRemark").value.trim();
    const ref=doc(db,"clients",id);
    const snap=await getDoc(ref);
    if(!snap.exists()) return alert("Record not found");
    const data=snap.data();
    let history=Array.isArray(data.history)?data.history.slice():[];
    if(note){
      history.push({ts:serverTimestamp(),user:currentUser?currentUser.email:"unknown",note:note,status:newStatus});
    }
    await updateDoc(ref,{status:newStatus,history:history});
    alert("Updated successfully!");
    closeModal();
    if(newStatus==="today") openPage("today");
    else if(newStatus==="future") openPage("future");
    else if(newStatus==="registered") openPage("registered");
    else if(newStatus==="noti") openPage("noti");
    else openPage("fresh");
    loadKpis(); loadRecent(); loadFresh(); if(unsub) loadList(newStatus);
  }catch(e){ console.error("quickUpdate",e); alert("Error updating"); }
}

// expose functions
window.openDetail = openDetail;
window.quickStatus = quickStatus;
window.removeClient = removeClient;
window.addFreshClient = addFreshClient;
window.addRemark = addRemark;
window.assignStaff = assignStaff;
window.recordOutcome = recordOutcome;

// initial
openPage('dashboard');
loadKpis();
loadRecent();

</script>
</body>
</html>
